<!DOCTYPE html>
<html>

<head>
    <style type="text/css">
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
        }
        #page {
            position:absolute;
            left: 0;
            right: 0;
            bottom: 0;
            top: 0;
            width: 100%;
            height: 100%;
        }
    </style>
</head>

  <body>
    <script>
        var indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB || window.shimIndexedDB;
        var open = indexedDB.open("gladiusDatabase", 1);
        open.onupgradeneeded = function() {
            var db = open.result;
            var store = db.createObjectStore("AssetObjectStore", {keyPath: "gladiusID"});
        };
        var storeAsset = function(id, blob) {
            console.log("Storing blob: " + id);
            var db = open.result;
            var tx = db.transaction("AssetObjectStore", "readwrite");
            var store = tx.objectStore("AssetObjectStore");
            store.put({gladiusID: id, data: blob});
            console.log("Stored blob: " + id);
        };
        var assignAssetBlob = function(gladiusID, element, attribute) {
            console.log("Retrieving blob: " + gladiusID);
            var db = open.result;
            var tx = db.transaction("AssetObjectStore", "readwrite");
            var store = tx.objectStore("AssetObjectStore");
            store.get(gladiusID).onsuccess = function(event) {
                var file = event.target.result.data;
                var URL = window.URL || window.webkitURL;
                var assetURL = URL.createObjectURL(file);
                element.setAttribute(attribute, assetURL);
            };
        };

        var sha256 = function a(b) {
            function c(a, b) {
            return a >>> b | a << 32 - b
            }
            for (var d, e, f = Math.pow, g = f(2, 32), h = "length", i = "", j = [], k = 8 * b[h], l = a.h = a.h || [], m = a.k = a.k || [], n = m[h], o = {}, p = 2; 64 > n; p++)
            if (!o[p]) {
                for (d = 0; 313 > d; d += p) o[d] = p;
                l[n] = f(p, .5) * g | 0, m[n++] = f(p, 1 / 3) * g | 0
            }
            for (b += "\x80"; b[h] % 64 - 56;) b += "\x00";
            for (d = 0; d < b[h]; d++) {
            if (e = b.charCodeAt(d), e >> 8) return;
            j[d >> 2] |= e << (3 - d) % 4 * 8
            }
            for (j[j[h]] = k / g | 0, j[j[h]] = k, e = 0; e < j[h];) {
            var q = j.slice(e, e += 16),
                r = l;
            for (l = l.slice(0, 8), d = 0; 64 > d; d++) {
                var s = q[d - 15],
                t = q[d - 2],
                u = l[0],
                v = l[4],
                w = l[7] + (c(v, 6) ^ c(v, 11) ^ c(v, 25)) + (v & l[5] ^ ~v & l[6]) + m[d] + (q[d] = 16 > d ? q[d] : q[d - 16] + (c(s, 7) ^ c(s, 18) ^ s >>> 3) + q[d - 7] + (c(t, 17) ^ c(t, 19) ^ t >>> 10) | 0),
                x = (c(u, 2) ^ c(u, 13) ^ c(u, 22)) + (u & l[1] ^ u & l[2] ^ l[1] & l[2]);
                l = [w + x | 0].concat(l), l[4] = l[4] + w | 0
            }
            for (d = 0; 8 > d; d++) l[d] = l[d] + r[d] | 0
            }
            for (d = 0; 8 > d; d++)
            for (e = 3; e + 1; e--) {
                var y = l[d] >> 8 * e & 255;
                i += (16 > y ? 0 : "") + y.toString(16)
            }
            return i
        };

        function getAndLoadEdgeContent() {
            var edgeHost = "{EDGEHOST}"
            var route = "{ROUTE}"
            const expectedHash = "{EXPECTEDHASH}"

            fetch(edgeHost + "&route=" + route).then(function(response) {
                return response.blob()
            }).then(function(content) {
                var fr = new FileReader();
                fr.readAsBinaryString(content)
                fr.onloadend = function () {
                    if (sha256(fr.result).toUpperCase() === expectedHash.toUpperCase()) {
                        var iframe = document.getElementById("page");
                        iframeDoc = iframe.contentWindow.document;
                        iframeDoc.open('text/html', 'replace');
                        iframeDoc.write(fr.result);
                        iframeDoc.close();

                        var assetPromises = [];
                        iframe.contentDocument.querySelectorAll("[gladiusID]").forEach(function(tag) {
                            assetPromises.push(new Promise(function(resolve, reject) {
                                var gladiusID = tag.attributes["gladiusID"].value
                                fetch(edgeHost + "&asset=" + gladiusID).then(function(response) {
                                    return response.blob()
                                }).then(function(assetBlob) {
                                    var fr = new FileReader();
                                    fr.readAsBinaryString(assetBlob);
                                    fr.onloadend = function () {
                                        if (sha256(fr.result).toUpperCase() === gladiusID.toUpperCase()) {
                                            storeAsset(gladiusID, assetBlob);
                                            console.log(tag.tagName);
                                            if (tag.tagName === "LINK") {
                                                assignAssetBlob(gladiusID, tag, "href")
                                            } else {
                                                assignAssetBlob(gladiusID, tag, "src");
                                            }
                                            
                                        } else {
                                            console.log("Resource hash was not as expected!");
                                            reject()
                                        }
                                    }
                                });
                            }));
                        });
                        Promise.all(assetPromises).then(function(values) {
                            console.log("Done loading assets")
                            
                        }).catch(function(values) {
                            
                        });
                    } else {
                        document.getElementById("page").innerHTML = "Something went wrong loading content."
                    }
                }
            });
        };

        getAndLoadEdgeContent()
    </script>

    <iframe id="page" frameborder="0"> </iframe>
  </body>

</html>
